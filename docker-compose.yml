version: '3.8'

services:
  # PHP 7.4 构建
  build-php74:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PHP_VERSION: "7.4"
        TARGETPLATFORM: linux/amd64
    volumes:
      - ./dist:/dist
    command: >
      sh -c "cp /build/target/release/libphp_guard.so /dist/php_guard_php74.so &&
             cp /build/target/release/php-guard /dist/php-guard || true"
             
  # PHP 7.4 构建 (ARM64)
  build-php74-arm64:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PHP_VERSION: "7.4"
        TARGETPLATFORM: linux/arm64
    volumes:
      - ./dist:/dist
    command: >
      sh -c "cp /build/target/aarch64-unknown-linux-gnu/release/libphp_guard.so /dist/php_guard_php74_arm64.so || true"

  # PHP 8.2 构建 (ARM64)
  build-php82-arm64:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PHP_VERSION: "8.2"
        TARGETPLATFORM: linux/arm64
    volumes:
      - ./dist:/dist
    command: >
      sh -c "cp /build/target/aarch64-unknown-linux-gnu/release/libphp_guard.so /dist/php_guard_php82_arm64.so || true"

  # 测试环境
  test:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PHP_VERSION: "8.3"
    volumes:
      - ./test:/test
    working_dir: /test
    command: php -d extension=php_guard -r "echo php_guard_version() . PHP_EOL;"

  # 一键构建所有版本
  build-all:
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        docker-compose build build-php74 &&
        docker-compose build build-php74-arm64 &&
        docker-compose build build-php82-arm64 &&
        echo 'All builds completed!'
      "
