name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-cli:
    name: Build CLI (${{ matrix.os }}/${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            target: x86_64-unknown-linux-gnu
            artifact: php-guard-linux-x64
            ext: ''
          - os: ubuntu-latest
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            artifact: php-guard-linux-aarch64
            ext: ''
          # - os: macos-latest
          #   target: x86_64-apple-darwin
          #   artifact: php-guard-macos-x64
          #   ext: ''
          # - os: macos-latest
          #   target: aarch64-apple-darwin
          #   artifact: php-guard-macos-arm64
          #   ext: ''
          - os: windows-latest
            arch: x64
            target: x86_64-pc-windows-msvc
            artifact: php-guard-windows-x64
            ext: '.exe'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85
          targets: ${{ matrix.target }}

      - name: Install AArch64 cross-compilation tools
        if: matrix.arch == 'aarch64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build
        env:
          CC: ${{ matrix.arch == 'aarch64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
        run: cargo build -p php-guard-cli --release --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/php-guard${{ matrix.ext }} dist/
          cp -r scripts dist/
          cp README.md LICENSE dist/
          tar -czvf ${{ matrix.artifact }}.tar.gz -C dist .

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir dist
          copy target\${{ matrix.target }}\release\php-guard${{ matrix.ext }} dist\
          xcopy scripts dist\scripts\ /E /I /Y
          copy README.md dist\
          copy LICENSE dist\
          Compress-Archive -Path dist\* -DestinationPath ${{ matrix.artifact }}.zip

      - name: Upload artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.zip

  build-extension-linux:
    name: Build Extension (Linux ${{ matrix.arch }} PHP ${{ matrix.php }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-unknown-linux-gnu
          - arch: aarch64
            target: aarch64-unknown-linux-gnu
        php: ['7.4', '8.2']
        # php: ['7.4', '8.0', '8.1', '8.2', '8.3', '8.4']
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          coverage: none

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85
          targets: ${{ matrix.target }}

      - name: Install libclang
        run: sudo apt-get install -y libclang-dev clang

      - name: Install AArch64 cross-compilation tools
        if: matrix.arch == 'aarch64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Generate config
        run: bash scripts/generate-key.sh

      - name: Build extension
        env:
          CC: ${{ matrix.arch == 'aarch64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
          CARGO_TARGET_${{ matrix.target == 'aarch64-unknown-linux-gnu' && 'AARCH64_UNKNOWN_LINUX_GNU' || '' }}_LINKER: ${{ matrix.arch == 'aarch64' && 'aarch64-linux-gnu-gcc' || '' }}
        run: cargo build --features php-extension --release --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/libphp_guard.so dist/php_guard_php${{ matrix.php }}_linux_${{ matrix.arch }}.so
          cp -r scripts dist/
          cp README.md LICENSE dist/
          tar -czvf php_guard-php${{ matrix.php }}-linux-${{ matrix.arch }}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: php_guard-php${{ matrix.php }}-linux-${{ matrix.arch }}
          path: php_guard-php${{ matrix.php }}-linux-${{ matrix.arch }}.tar.gz

  # build-extension-macos:
  #   name: Build Extension (macOS PHP ${{ matrix.php }})
  #   runs-on: macos-latest
  #   strategy:
  #     matrix:
  #       php: ['7.4', '8.2']
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Setup PHP
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: ${{ matrix.php }}
  #           coverage: none
  #
  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@master
  #       with:
  #         toolchain: 1.85
  #
  #     - name: Install LLVM and Clang
  #       run: brew install llvm
  #
  #     - name: Generate config
  #       run: bash scripts/generate-key.sh
  #
  #     - name: Build extension
  #       env:
  #         LIBCLANG_PATH: /usr/local/opt/llvm/lib
  #       run: cargo build --features php-extension --release
  #
  #     - name: Package
  #       run: |
  #         mkdir -p dist
  #         cp target/release/libphp_guard.dylib dist/php_guard_php${{ matrix.php }}_macos.dylib
  #         cp -r scripts dist/
  #         cp README.md LICENSE dist/
  #         tar -czvf php_guard-php${{ matrix.php }}-macos.tar.gz -C dist .
  #
  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: php_guard-php${{ matrix.php }}-macos
  #         path: php_guard-php${{ matrix.php }}-macos.tar.gz

  release:
    name: Create Release
    needs: [build-cli, build-extension-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          generate_release_notes: true
          body: |
            ## PHP-Guard ${{ github.ref_name }}
            
            ### 下载说明
            
            **CLI 工具:**
            | 平台 | 文件 |
            |------|------|
            | Linux x64 | `php-guard-linux-x64.tar.gz` |
            | Linux aarch64 | `php-guard-linux-aarch64.tar.gz` |
            | Windows x64 | `php-guard-windows-x64.zip` |
            
            **PHP 扩展 (Linux):**
            | 平台 | PHP 版本 | 文件 |
            |------|----------|------|
            | Linux x64 | PHP 7.4 | `php_guard-php7.4-linux-x64.tar.gz` |
            | Linux aarch64 | PHP 7.4 | `php_guard-php7.4-linux-aarch64.tar.gz` |
            | Linux x64 | PHP 8.2 | `php_guard-php8.2-linux-x64.tar.gz` |
            | Linux aarch64 | PHP 8.2 | `php_guard-php8.2-linux-aarch64.tar.gz` |
            
            ### 安装步骤
            
            **1. 安装 PHP 扩展**
            ```bash
            # 解压扩展包
            tar -xzf php_guard-php8.2-linux-x64.tar.gz
            
            # 安装扩展到 PHP
            sudo cp php_guard_php8.2_linux_x64.so $(php-config --extension-dir)/php_guard.so
            
            # 启用扩展
            echo "extension=php_guard.so" | sudo tee /etc/php/conf.d/php_guard.ini
            ```
            
            **2. 生成密钥配置**
            ```bash
            # 解压 CLI 工具包（包含 scripts 目录）
            tar -xzf php-guard-linux-x64.tar.gz
            
            # 生成加密密钥
            bash scripts/generate-key.sh
            
            # 配置文件将保存到 .php-guard/config.env
            ```
            
            **3. 重新构建扩展（使用您的密钥）**
            ```bash
            # 克隆仓库
            git clone https://github.com/yourname/php-guard.git
            cd php-guard
            
            # 使用 CLI 工具包中的脚本生成配置
            bash ../scripts/generate-key.sh
            
            # 构建扩展
            cargo build --features php-extension --release
            
            # 安装
            sudo cp target/release/libphp_guard.so $(php-config --extension-dir)/php_guard.so
            ```
            
            **4. 加密 PHP 文件**
            ```bash
            # 加密单个文件
            ./php-guard encrypt example.php
            
            # 加密目录
            ./php-guard encrypt src/
            
            # 检查加密状态
            ./php-guard check src/
            ```
            
            ### 重要说明
            
            ⚠️ **密钥配置**
            - 预编译的扩展使用随机密钥，仅用于测试
            - 生产环境请务必生成自己的密钥并重新编译
            - 密钥配置文件 `.php-guard/config.env` 请妥善保管
            
            ⚠️ **Windows 支持**
            - 目前 Windows 原生编译不支持
            - 建议使用 WSL 或 Docker
            
            ### 可用命令
            
            CLI 工具支持以下命令：
            - `./php-guard encrypt <path>` - 加密文件或目录
            - `./php-guard check <path>` - 检查加密状态
            - `./php-guard --help` - 显示帮助信息
            
            脚本工具：
            - `scripts/generate-key.sh` - 生成密钥配置（Linux/macOS）
            - `scripts/generate-key.bat` - 生成密钥配置（Windows）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
