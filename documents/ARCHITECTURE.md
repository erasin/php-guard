# PHP-Guard 架构设计文档

## 项目概述

PHP-Guard 是一个基于 Rust (phper 框架) 开发的 PHP7+ 代码加密扩展，提供高性能、跨平台的 PHP 源码保护方案。

## 设计目标

1. **简洁高效** - 采用轻量级 XOR 加密算法，运行时性能损耗极小
2. **透明解密** - 无需修改 PHP 代码，扩展自动处理加密文件
3. **跨平台** - 支持 Linux、macOS 等主流操作系统
4. **兼容性好** - 兼容 OPcache、Xdebug 等扩展，支持 CLI 和 FPM 模式
5. **可定制** - 支持自定义加密头和密钥
6. **模块化** - 核心库、扩展、CLI 分离，便于复用和测试

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         PHP 运行时                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐      ┌─────────────────────────────────┐     │
│   │  PHP 脚本   │ ───▶ │  zend_compile_file (被 Hook)    │     │
│   └─────────────┘      └─────────────────────────────────┘     │
│                                      │                          │
│                                      ▼                          │
│                        ┌─────────────────────────┐              │
│                        │   php-guard-ext 扩展    │              │
│                        ├─────────────────────────┤              │
│                        │ 1. 检测加密文件头        │              │
│                        │ 2. 读取加密内容          │              │
│                        │ 3. 调用 core 解密        │              │
│                        │ 4. 返回给 PHP 编译       │              │
│                        └─────────────────────────┘              │
│                                      │                          │
│                                      ▼                          │
│                        ┌─────────────────────────┐              │
│                        │  Zend 编译器 & 执行器   │              │
│                        └─────────────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 模块架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        php-guard-cli                            │
│                     (命令行工具)                                 │
├─────────────────────────────────────────────────────────────────┤
│                        php-guard-ext                            │
│                     (PHP 扩展 cdylib)                           │
│              hooks.rs │ php_extension.rs                        │
├─────────────────────────────────────────────────────────────────┤
│                        php-guard-core                           │
│                       (核心库 rlib)                             │
│          crypto.rs │ file_handler.rs │ config.rs               │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. php-guard-core (核心库)

#### 加密模块 (`src/crypto.rs`)

负责加密/解密算法实现：

```
加密流程:
1. 添加加密文件头 (magic header)
2. 对奇数位字节进行 XOR 加密
3. 密钥轮转使用，增强安全性

加密算法:
for i in 0..len {
    if i & 1 == 1 {
        p = (p + key[p] + i) % key_len
        data[i] = !(data[i] ^ key[p])
    }
}
```

#### 文件处理模块 (`src/file_handler.rs`)

负责文件读取、检测和处理：

- 检测文件是否已加密
- 读取加密文件内容
- 解密后返回可编译内容

#### 配置模块 (`src/config.rs`)

管理加密配置：

```rust
struct Config {
    header: Vec<u8>,  // 加密文件头标识
    key: Vec<u8>,     // 加密密钥
}
```

### 2. php-guard-ext (PHP 扩展)

#### PHP 扩展入口 (`src/lib.rs`)

PHP 扩展主入口：

- 注册 PHP 模块
- 提供 `php_guard_encode()` 函数用于加密
- 导出 `register_module()` 函数

#### PHP Hook (`src/hooks.rs`)

Hook 机制实现：

- 保存原始 `zend_compile_file` 指针
- 替换为自定义编译函数
- 运行时检测并解密加密文件

#### PHP 扩展注册 (`src/php_extension.rs`)

注册 PHP 函数：

- `php_guard_encode()` - 加密内容
- `php_guard_is_encrypted()` - 检查加密状态
- `php_guard_version()` - 获取版本

### 3. php-guard-cli (CLI 工具)

命令行工具：

- `encrypt` - 加密 PHP 文件
- `check` - 检查加密状态
- `decrypt` - 解密 PHP 文件

## 加密文件格式

```
┌────────────────────────┬──────────────────────────────┐
│   加密头 (12-16 bytes)  │      加密后的 PHP 源码        │
├────────────────────────┼──────────────────────────────┤
│  0x66 0x88 0xff ...    │  (XOR 加密后的字节流)         │
└────────────────────────┴──────────────────────────────┘
```

## 工作流程

### 加密流程 (CLI 工具)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 原始 PHP    │ ──▶ │ 添加加密头  │ ──▶ │ XOR 加密    │
│ 源文件      │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
                                                │
                                                ▼
                                         ┌─────────────┐
                                         │ 加密后文件  │
                                         └─────────────┘
```

### 解密流程 (运行时)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 加密文件    │ ──▶ │ 检测加密头  │ ──▶ │ XOR 解密    │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
                                                │
                                                ▼
                                         ┌─────────────┐
                                         │ 原始源码    │
                                         │ 交由 PHP    │
                                         └─────────────┘
```

## 项目结构

```
php-guard/
├── Cargo.toml              # Workspace 配置
├── crates/
│   ├── php-guard-core/     # 核心库 (加密/解密算法)
│   │   ├── Cargo.toml
│   │   ├── build.rs        # 配置生成
│   │   ├── src/
│   │   │   ├── lib.rs
│   │   │   ├── config.rs   # 配置 (自动生成)
│   │   │   ├── crypto.rs   # 加密算法
│   │   │   └── file_handler.rs
│   │   └── examples/
│   │       └── encrypt_file.rs
│   ├── php-guard-ext/      # PHP 扩展
│   │   ├── Cargo.toml
│   │   └── src/
│   │       ├── lib.rs
│   │       ├── hooks.rs    # PHP hook
│   │       └── php_extension.rs
│   └── php-guard-cli/      # CLI 工具
│       ├── Cargo.toml
│       └── src/
│           ├── main.rs
│           └── commands.rs
├── scripts/
│   ├── generate-key.sh     # 密钥生成 (Linux/macOS)
│   └── generate-key.bat    # 密钥生成 (Windows)
├── .php-guard/
│   └── config.env          # 密钥配置（不提交）
├── documents/
│   ├── ARCHITECTURE.md     # 架构文档
│   ├── USAGE.md            # 使用指南
│   └── REFACTORING_REPORT.md # 重构报告
└── README.md               # 使用说明
```

## 安全考虑

1. **密钥保护** 
   - 密钥在编译时生成，存储在 `.php-guard/config.env`
   - 配置文件已添加到 `.gitignore`，防止泄露
   - 建议设置文件权限：`chmod 600 .php-guard/config.env`

2. **文件头定制** - 使用自定义文件头增加识别难度

3. **算法简单** - 出于性能考虑，算法较简单但不易被逆向

4. **建议** 
   - 仅加密核心业务代码，减少暴露面
   - 不同环境使用不同密钥
   - 定期更换密钥
   - 安全备份配置文件

## 性能特性

- 加密算法时间复杂度: O(n)
- 内存开销: 仅需临时缓冲区
- 实测性能损耗: < 1%

## 兼容性

| 类别 | 项目 | 状态 |
|------|------|------|
| OS | Linux | ✅ |
| OS | macOS | ✅ |
| PHP | 7.0 - 7.4 | ✅ |
| PHP | 8.0 - 8.5 | ✅ |
| SAPI | CLI | ✅ |
| SAPI | FPM | ✅ |
| 扩展 | OPcache | ✅ |
| 扩展 | Xdebug | ✅ |

## 依赖

- Rust 1.85+
- libclang 9.0+
- PHP 7.0+
- phper 0.17.x
