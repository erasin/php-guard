# PHP-Guard 架构设计文档

## 项目概述

PHP-Guard 是一个基于 Rust (phper 框架) 开发的 PHP7+ 代码加密扩展，提供高性能、跨平台的 PHP 源码保护方案。

## 设计目标

1. **简洁高效** - 采用轻量级 XOR 加密算法，运行时性能损耗极小
2. **透明解密** - 无需修改 PHP 代码，扩展自动处理加密文件
3. **跨平台** - 支持 Linux、macOS 等主流操作系统
4. **兼容性好** - 兼容 OPcache、Xdebug 等扩展，支持 CLI 和 FPM 模式
5. **可定制** - 支持自定义加密头和密钥

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         PHP 运行时                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐      ┌─────────────────────────────────┐     │
│   │  PHP 脚本   │ ───▶ │  zend_compile_file (被 Hook)    │     │
│   └─────────────┘      └─────────────────────────────────┘     │
│                                      │                          │
│                                      ▼                          │
│                        ┌─────────────────────────┐              │
│                        │    php-guard 扩展       │              │
│                        ├─────────────────────────┤              │
│                        │ 1. 检测加密文件头        │              │
│                        │ 2. 读取加密内容          │              │
│                        │ 3. 解密还原源码          │              │
│                        │ 4. 返回给 PHP 编译       │              │
│                        └─────────────────────────┘              │
│                                      │                          │
│                                      ▼                          │
│                        ┌─────────────────────────┐              │
│                        │  Zend 编译器 & 执行器   │              │
│                        └─────────────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. 加密核心模块 (`src/crypto.rs`)

负责加密/解密算法实现：

```
加密流程:
1. 添加加密文件头 (magic header)
2. 对奇数位字节进行 XOR 加密
3. 密钥轮转使用，增强安全性

加密算法:
for i in 0..len {
    if i & 1 == 1 {
        p = (p + key[p] + i) % key_len
        data[i] = !(data[i] ^ key[p])
    }
}
```

### 2. 文件处理模块 (`src/file_handler.rs`)

负责文件读取、检测和处理：

- 检测文件是否已加密
- 读取加密文件内容
- 解密后返回可编译内容

### 3. PHP 扩展入口 (`src/lib.rs`)

PHP 扩展主入口：

- 注册 PHP 模块
- 提供 `php_guard_encode()` 函数用于加密
- Hook `zend_compile_file` 实现透明解密

### 4. 配置模块 (`src/config.rs`)

管理加密配置：

```rust
struct Config {
    header: Vec<u8>,  // 加密文件头标识
    key: Vec<u8>,     // 加密密钥
}
```

## 加密文件格式

```
┌────────────────────────┬──────────────────────────────┐
│   加密头 (12-16 bytes)  │      加密后的 PHP 源码        │
├────────────────────────┼──────────────────────────────┤
│  0x66 0x88 0xff ...    │  (XOR 加密后的字节流)         │
└────────────────────────┴──────────────────────────────┘
```

## 工作流程

### 加密流程 (CLI 工具)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 原始 PHP    │ ──▶ │ 添加加密头  │ ──▶ │ XOR 加密    │
│ 源文件      │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │ 加密后文件  │
                                        └─────────────┘
```

### 解密流程 (运行时)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 加密文件    │ ──▶ │ 检测加密头  │ ──▶ │ XOR 解密    │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │ 原始源码    │
                                        │ 交由 PHP    │
                                        └─────────────┘
```

## 项目结构

```
php-guard/
├── Cargo.toml              # Rust 项目配置
├── src/
│   ├── lib.rs              # PHP 扩展入口
│   ├── crypto.rs           # 加密/解密算法
│   ├── file_handler.rs     # 文件处理
│   └── config.rs           # 配置管理
├── tools/
│   └── php-guard.php       # PHP 加密工具脚本
├── documents/
│   └── ARCHITECTURE.md     # 架构文档
└── README.md               # 使用说明
```

## 安全考虑

1. **密钥保护** - 密钥编译在扩展中，建议自定义修改
2. **文件头定制** - 使用自定义文件头增加识别难度
3. **算法简单** - 出于性能考虑，算法较简单但不易被逆向
4. **建议** - 仅加密核心业务代码，减少暴露面

## 性能特性

- 加密算法时间复杂度: O(n)
- 内存开销: 仅需临时缓冲区
- 实测性能损耗: < 1%

## 兼容性

| 类别 | 项目 | 状态 |
|------|------|------|
| OS | Linux | ✅ |
| OS | macOS | ✅ |
| PHP | 7.0 - 7.4 | ✅ |
| PHP | 8.0 - 8.5 | ✅ |
| SAPI | CLI | ✅ |
| SAPI | FPM | ✅ |
| 扩展 | OPcache | ✅ |
| 扩展 | Xdebug | ✅ |

## 依赖

- Rust 1.85+
- libclang 9.0+
- PHP 7.0+
- phper 0.15.x
